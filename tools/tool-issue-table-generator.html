<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>附件：爭點整理表格產生器 (標題緊湊修正版)</title>
    <!-- 引入 Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- 引入 html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* 基礎設定 */
        * { box-sizing: border-box; }
        
        body {
            background-color: #f5f2eb;
            padding: 20px;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
        }

        /* --- PDF 預覽區 --- */
        #pdf-preview-container {
            background: white;
            width: 210mm; 
            min-height: 297mm;
            padding: 15mm 8mm; 
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            color: black;
            position: relative;
        }

        /* --- 表格樣式 --- */
        .legal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12pt; 
            table-layout: fixed;
            border: 2px solid black;
        }

        .legal-table th, .legal-table td {
            border: 1px solid black;
            padding: 4px; 
            vertical-align: top;
            font-size: 12pt;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        /* --- 重點修正：當事人列的極限壓縮 --- */
        .compact-row td {
            /* 將上方內距設為 0，讓內容貼頂 */
            padding-top: 0px !important;    
            padding-bottom: 2px !important;
            vertical-align: top;
        }

        tr {
            page-break-inside: auto;
            page-break-after: auto;
        }
        
        thead tr {
            page-break-inside: avoid;
        }

        /* 欄位寬度 */
        .col-header { width: 12%; text-align: center; font-weight: bold; vertical-align: middle; }
        .col-content { width: 14.6%; }

        .center-align { text-align: center; vertical-align: middle; }
        
        .left-align { 
            text-align: left;
            vertical-align: top;
            /* 這裡的 padding 會被 .compact-row td 覆蓋 */
        }

        /* --- 重點修正：稱謂標題樣式 --- */
        .party-title {
            font-weight: bold;
            margin-bottom: 0px; 
            /* 關鍵：使用負邊距將文字往上拉，消除字體上方留白 */
            margin-top: -3px;     
            text-align: center; 
            font-size: 12pt;
            /* 緊湊行高 */
            line-height: 1.2; 
            /* 確保這是一個區塊元素 */
            display: block;
        }

        .party-name-content {
            text-align: left;
            padding-left: 2px;
            display: block;
            width: 100%;
            margin: 0; 
            line-height: 1.15; 
        }

        .doc-title { 
            font-size: 16pt; 
            font-weight: bold; 
            margin-bottom: 15px; 
        }

        /* --- 輸入區樣式 --- */
        .input-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            height: calc(100vh - 40px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        
        .issue-block {
            border-left: 5px solid #0d6efd;
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .section-title {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #555;
        }

        .char-counter {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: right;
            margin-top: 2px;
        }
        
        .char-counter.limit-reached {
            color: #dc3545;
            font-weight: bold;
        }

        /* 勾選區 */
        .checkbox-group {
            background-color: #f1f3f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .form-check-inline {
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .form-check-label {
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* 垃圾桶按鈕 */
        .btn-trash {
            color: #dc3545;
            border-color: #dc3545;
            background: white;
            padding: 4px 10px;
        }
        .btn-trash:hover {
            background-color: #dc3545;
            color: white;
        }

        /* 版權宣告 */
        .copyright-text {
            text-align: center;
            color: #adb5bd;
            font-size: 0.8rem;
            margin-top: 15px;
            font-family: Arial, sans-serif;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            #pdf-preview-container { margin: 0; padding: 0; width: 100%; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- 左側：資料輸入區 -->
        <div class="col-md-4 no-print">
            <div class="input-panel">
                <h4 class="mb-4 text-primary"><i class="bi bi-pencil-square"></i> 爭點整理表格小工具</h4>
                
                <!-- 0. 標題設定 -->
                <div class="mb-4">
                    <div class="section-title">0. 表格標題設定</div>
                    <input type="text" class="form-control" id="input_doc_title" value="附件：爭點整理表格">
                    <div class="form-text text-muted">可修改上方標題文字</div>
                </div>

                <!-- 1. 當事人設定 -->
                <div class="mb-4">
                    <div class="section-title">1. 當事人稱謂與姓名</div>
                    
                    <label class="fw-bold mb-1 text-primary">左欄設定</label>
                    <div class="checkbox-group" id="left-title-options"></div>
                    <div class="mb-3">
                        <textarea class="form-control" id="input_plaintiff" rows="3" maxlength="150" placeholder="輸入姓名 (例如：某某公司&#10;法定代理人：王小明)"></textarea>
                        <div class="char-counter" id="cnt_plaintiff">限制：0/150字</div>
                    </div>

                    <hr>

                    <label class="fw-bold mb-1 text-danger">右欄設定</label>
                    <div class="checkbox-group" id="right-title-options"></div>
                    <div class="mb-2">
                        <textarea class="form-control" id="input_defendant" rows="3" maxlength="150" placeholder="輸入姓名 (例如：陳大華)"></textarea>
                        <div class="char-counter" id="cnt_defendant">限制：0/150字</div>
                    </div>
                </div>

                <!-- 2. 聲明 -->
                <div class="mb-4">
                    <div class="section-title">2. 聲明事項</div>
                    <div class="mb-2">
                        <label>左方聲明</label>
                        <textarea class="form-control" id="input_decl_plaintiff" rows="4">1. 上訴駁回&#10;2. 訴訟費用由上訴人負擔</textarea>
                    </div>
                    <div class="mb-2">
                        <label>右方聲明</label>
                        <textarea class="form-control" id="input_decl_defendant" rows="4">1. 原判決廢棄&#10;2.</textarea>
                    </div>
                </div>

                <!-- 3. 爭點 -->
                <div id="issues-container"></div>

                <div class="d-grid gap-2 pt-3 border-top">
                    <!-- 增加爭點按鈕 -->
                    <button class="btn btn-outline-primary" onclick="addNewIssue(true)">
                        <i class="bi bi-plus-circle"></i> 增加新爭點
                    </button>
                    <!-- 下載按鈕 -->
                    <button class="btn btn-success btn-lg mt-2" onclick="generatePDF()">
                        <i class="bi bi-download"></i> 下載 PDF
                    </button>
                    <!-- 版權宣告 -->
                    <div class="copyright-text">
                        &copy; 2025 楊時綱. All Rights Reserved.
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側：PDF 預覽區 -->
        <div class="col-md-8 d-flex justify-content-center">
            <div>
                <div id="pdf-preview-container">
                    <div class="doc-title" id="out_doc_title">附件：爭點整理表格</div>
                    
                    <table class="legal-table">
                        <thead>
                            <!-- 第一列：當事人 (加入 compact-row 類別進行高度壓縮) -->
                            <tr class="compact-row">
                                <td class="col-header">項目</td>
                                <td colspan="3" class="left-align">
                                    <div class="party-title" id="out_title_left">被上訴人 （即原審原告）</div>
                                    <div class="party-name-content" id="out_plaintiff"></div>
                                </td>
                                <td colspan="3" class="left-align">
                                    <div class="party-title" id="out_title_right">上訴人 （即原審被告）</div>
                                    <div class="party-name-content" id="out_defendant"></div>
                                </td>
                            </tr>
                            
                            <!-- 第二列：聲明 -->
                            <tr>
                                <td class="col-header">聲明</td>
                                <td colspan="3" id="out_decl_plaintiff"></td>
                                <td colspan="3" id="out_decl_defendant"></td>
                            </tr>

                            <!-- 第三列：標題 -->
                            <tr style="background-color: #f2f2f2;">
                                <td class="col-header">陳述<br>及<br>證據</td>
                                <td class="col-content center-align"><b>主張<br>原因事實</b></td>
                                <td class="col-content center-align"><b>法律依據</b></td>
                                <td class="col-content center-align"><b>證據</b></td>
                                <td class="col-content center-align"><b>答辯<br>原因事實</b></td>
                                <td class="col-content center-align"><b>法律依據</b></td>
                                <td class="col-content center-align"><b>證據</b></td>
                            </tr>
                        </thead>
                        
                        <tbody id="table-issues-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let uniqueIdCounter = 0;
    const chineseNumbers = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '十一', '十二', '十三', '十四', '十五'];
    const titleOptions = ['原告', '被告', '上訴人', '被上訴人', '（即原審原告）', '（即原審被告）'];

    window.onload = function() {
        initTitleCheckboxes();
        addNewIssue(false); // 預設加入爭點一
        bindStaticInputs();
    };

    function initTitleCheckboxes() {
        createCheckboxes('left-title-options', 'chk-left', 'out_title_left', ['被上訴人', '（即原審原告）']);
        createCheckboxes('right-title-options', 'chk-right', 'out_title_right', ['上訴人', '（即原審被告）']);
    }

    function createCheckboxes(containerId, className, outputId, defaultChecks) {
        const container = document.getElementById(containerId);
        
        titleOptions.forEach((opt, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-check form-check-inline';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = `form-check-input ${className}`;
            checkbox.id = `${className}_${index}`;
            checkbox.value = opt;
            
            if (defaultChecks.includes(opt)) {
                checkbox.checked = true;
            }

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = checkbox.id;
            label.innerText = opt;

            checkbox.addEventListener('change', () => updateTitle(className, outputId));

            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);
            container.appendChild(wrapper);
        });
        updateTitle(className, outputId);
    }

    function updateTitle(className, outputId) {
        const checkedBoxes = document.querySelectorAll(`.${className}:checked`);
        const values = Array.from(checkedBoxes).map(cb => cb.value);
        document.getElementById(outputId).innerText = values.join(' ');
    }

    function bindStaticInputs() {
        bindInputSimple('input_doc_title', 'out_doc_title');
        bindInputWithLimit('input_plaintiff', 'out_plaintiff', 'cnt_plaintiff');
        bindInputWithLimit('input_defendant', 'out_defendant', 'cnt_defendant');
        bindInputSimple('input_decl_plaintiff', 'out_decl_plaintiff');
        bindInputSimple('input_decl_defendant', 'out_decl_defendant');
    }

    function bindInputSimple(inputId, outId) {
        const input = document.getElementById(inputId);
        const output = document.getElementById(outId);
        if(input && output) {
            output.innerText = input.value;
            input.addEventListener('input', (e) => {
                output.innerText = e.target.value;
            });
        }
    }

    function bindInputWithLimit(inputId, outId, counterId) {
        const input = document.getElementById(inputId);
        const output = document.getElementById(outId);
        const counter = document.getElementById(counterId);

        if(input && output) {
            output.innerText = input.value;
            updateCounter(input, counter);
            input.addEventListener('input', (e) => {
                output.innerText = e.target.value;
                updateCounter(e.target, counter);
            });
        }
    }

    function updateCounter(inputElement, counterElement) {
        if (!counterElement) return;
        const currentLength = inputElement.value.length;
        const limit = 150;
        counterElement.innerText = `限制：${currentLength}/${limit}字`;
        
        if (currentLength >= limit) {
            counterElement.classList.add('limit-reached');
        } else {
            counterElement.classList.remove('limit-reached');
        }
    }

    function addNewIssue(isRemovable = true) {
        uniqueIdCounter++;
        const currentId = uniqueIdCounter;
        
        // 左側輸入區塊
        const container = document.getElementById('issues-container');
        const issueDiv = document.createElement('div');
        issueDiv.className = 'issue-block';
        issueDiv.id = `issue-block-${currentId}`;

        // 標題與刪除按鈕
        let headerHtml = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0 issue-label-text">爭點</h5>
        `;
        
        if (isRemovable) {
            headerHtml += `
                <button class="btn btn-outline-danger btn-sm btn-trash" onclick="removeIssue(${currentId})" title="刪除此爭點">
                    <i class="bi bi-trash"></i>
                </button>
            `;
        }
        headerHtml += `</div>`;
        
        const fields = [
            { id: `p_fact_${currentId}`, label: '主張/原因事實', col: '12' },
            { id: `p_law_${currentId}`, label: '法律依據', col: '6' },
            { id: `p_evid_${currentId}`, label: '證據', col: '6' },
            { id: `d_fact_${currentId}`, label: '答辯/原因事實', col: '12', isRight: true },
            { id: `d_law_${currentId}`, label: '法律依據', col: '6', isRight: true },
            { id: `d_evid_${currentId}`, label: '證據', col: '6', isRight: true },
        ];

        let html = headerHtml + `<div class="row g-2">`;
        html += `<div class="col-12 text-primary fw-bold">左欄內容</div>`;
        
        fields.forEach((f, index) => {
            if (index === 3) {
                 html += `<div class="col-12 text-danger fw-bold mt-3 border-top pt-2">右欄內容</div>`;
            }
            html += `
                <div class="col-md-${f.col}">
                    <textarea class="form-control" id="${f.id}" rows="${f.col === '12' ? 3 : 2}" maxlength="150" placeholder="${f.label}"></textarea>
                    <div class="char-counter" id="cnt_${f.id}">限制：0/150字</div>
                </div>
            `;
        });
        html += `</div>`;
        issueDiv.innerHTML = html;
        container.appendChild(issueDiv);

        // 右側表格列
        const tbody = document.getElementById('table-issues-body');
        const tr = document.createElement('tr');
        tr.id = `issue-row-${currentId}`; 
        
        tr.innerHTML = `
            <td class="col-header center-align issue-table-label">爭點<br>：</td>
            <td id="out_p_fact_${currentId}"></td>
            <td id="out_p_law_${currentId}"></td>
            <td id="out_p_evid_${currentId}"></td>
            <td id="out_d_fact_${currentId}"></td>
            <td id="out_d_law_${currentId}"></td>
            <td id="out_d_evid_${currentId}"></td>
        `;
        tbody.appendChild(tr);

        fields.forEach(f => {
            bindInputWithLimit(f.id, `out_${f.id}`, `cnt_${f.id}`);
        });

        renumberIssues();
        
        if (isRemovable) {
            setTimeout(() => issueDiv.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }
    }

    function removeIssue(id) {
        if (!confirm('確定要刪除這個爭點嗎？此動作無法復原。')) return;

        const block = document.getElementById(`issue-block-${id}`);
        if (block) block.remove();

        const row = document.getElementById(`issue-row-${id}`);
        if (row) row.remove();

        renumberIssues();
    }

    function renumberIssues() {
        const inputLabels = document.querySelectorAll('.issue-label-text');
        const tableLabels = document.querySelectorAll('.issue-table-label');

        inputLabels.forEach((label, index) => {
            const num = index + 1;
            const chinNum = getChineseNumber(num);
            label.innerText = `爭點${chinNum}`;
        });

        tableLabels.forEach((label, index) => {
            const num = index + 1;
            const chinNum = getChineseNumber(num);
            label.innerHTML = `爭點<br>${chinNum}：`;
        });
    }

    function getChineseNumber(num) {
        if(num < chineseNumbers.length) return chineseNumbers[num];
        return num.toString();
    }

    function generatePDF() {
        const element = document.getElementById('pdf-preview-container');
        const opt = {
            margin:       0, 
            filename:     '爭點整理表格.pdf',
            image:        { type: 'jpeg', quality: 1 },
            html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['css', 'legacy'] } 
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>